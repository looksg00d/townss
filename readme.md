# Обзор текущего состояния и необходимых изменений

Давайте составим, что мы уже знаем из текущей кодовой базы, и какие задачи нам нужно решить.

---

## Что у нас есть

1. **Работа с инсайтами из JSON**
   - Используется директория (например, "C:\Users\User\Desktop\wwww\crypto-chat\data\alpha_insights") для хранения инсайтов.
   - Сервис `InsightReaderService` уже настроен на чтение инсайтов из этой директории.
   - При выборе темы для обсуждения (топика) берётся содержимое инсайта.

2. **Функциональность шаблонов и их управление**
   - Файл `towns/manage-templates.js` содержит функции для работы с диалоговыми шаблонами:
     - **listTemplates** — выводит список шаблонов (здесь выводится ID, тема, дата создания и **Message Count**).
     - **viewTemplate** — выводит детали выбранного шаблона.
     - **deleteTemplate** — удаляет выбранный шаблон.
     - **testTemplate** — позволяет протестировать шаблон (например, получить случайное сообщение для профиля).
     - **previewDiscussion** — функция предварительного просмотра обсуждения инсайта.

3. **Предварительный просмотр обсуждения**
   - Функция `previewDiscussion` в `manage-templates.js`:
     - Получает список инсайтов через `InsightReaderService`.
     - Позволяет выбрать инсайт (тема берётся из содержания инсайта).
     - Загружает профили через `loadProfiles` и позволяет пользователю выбрать, какие профили будут участвовать в обсуждении.
     - Если пользователь не выбирает профили, тогда происходит **случайный выбор**: - я не пойму почему мы заново реализуем это - какая функция отвечала за это в run-discussion.js?
       - Сначала берутся настройки обсуждения через `getDiscussionSettings` (в которых задается диапазон количества участников).
       - С помощью функции `shuffleArray` случайным образом выбираются профили, исключая, например, профиль с персонажем `ALPHA_INSIDER`.
     - Генерируются ответы для выбранных профилей с помощью `ResponseGeneratorService` (используется API OpenAI).
     - Результат выводится в консоль и при необходимости сохраняется в JSON-файл (например, в директории `towns/data/previews`).

4. **Рандомное число сообщений (Message Count) в run-discussion**
   - В файле `towns/run-discussion.js` используется логика для выполнения обсуждения:
     - **Message Count** (количество сообщений) генерируется случайным образом в определённом диапазоне (на основе настроек обсуждения).
     - Это число определяет, сколько сообщений будет сгенерировано для обсуждения.

---

## Что нам нужно

1. **Интеграция с веб-интерфейсом (страница /templates)**
   - Добавить возможность предварительного просмотра обсуждения через веб-интерфейс.
   - На странице по адресу `http://localhost:3000/templates` должны быть:
     - Список доступных диалоговых шаблонов и инсайтов (с информацией об ID, теме, Message Count и т.д.).
     - Возможность выбрать инсайт (топик) для предварительного просмотра обсуждения.
     - Возможность выбора профилей для генерации ответов (или автоматический случайный выбор, если профили не выбраны).

2. **Отображение и объяснение Message Count**
   - На странице шаблонов (и при предварительном просмотре) нужно разъяснить, что **Message Count** означает:
     - Количество сообщений, которое будет сгенерировано в обсуждении.
     - Это значение выбирается случайно в `run-discussion.js` согласно настройкам обсуждения (диапазон min–max).
   
3. **Хранение предварительного просмотра**
   - Результаты предварительного просмотра обсуждения сохраняются в формате JSON.
   - Это позволяет сохранять историю предварительного просмотра, что полезно для последующего анализа или повторного использования.

4. **Общее улучшение UX**
   - Обеспечить единообразие работы функционала как в CLI (через `manage-templates.js`), так и в веб-интерфейсе.
   - Предоставить пользователю выбор между ручным выбором профилей или автоматическим (случайным) подбором на основе настроек.

---

## Итоговая картина

- **Исходные данные (топик)** берутся из инсайтов, хранящихся в директории (например, `data/alpha_insights`).
- **Выбор профилей**: пользователь может выбрать, а если не выбирает — используется функция `shuffleArray` и настройки обсуждения для случайного выбора.
- **Message Count**: количество генерируемых сообщений определяется случайным образом в `run-discussion.js` по диапазону из настроек.
- **Хранение**: предварительные просмотры сохраняются в JSON (в структуре, подобной той, что реализована в `previewDiscussion`).

Эти знания позволяют нам сформировать план для дальнейшей интеграции функционала предварительного просмотра обсуждения в веб-страницу `/templates` и более понятное представление параметра **Message Count**.

---

Этот обзор поможет определить, какие изменения нужно внести для достижения поставленных целей. Теперь мы можем перейти к конкретным шагам по интеграции веб-интерфейса и уточнению логики выбора инсайтов и профилей.